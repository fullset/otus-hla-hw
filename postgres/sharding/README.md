# Задание по шардированию.

## Содержание директории:
- docker-compose.yaml поднимает кластер citus с 1 координатором и 2-мя воркерами, накатывает DDL (в контейнере migrator) и запускает приложение social_net_app, слушающее 8083 порт.
- Dockerfile - описывает контейнер для приложения
- migrator-sh-init.sh + migrator.Dockerfile - описывает конйтейнер для наката DDL на БД, дополнительно делает таблицу распределенной (шардированной) + точка входа
- cfg.yaml - конфигурационный файл для приложения

## Комментарии
- Методы `/dialog/` реализованы с некоторыми допущениями в /src/web/dialog.rs (из корня репозитория).
- текстовые сообщения хранятся в таблице social_net.messages, DDL которой описан в /postgres/schema/0002_messages/apply.sql. Распределенной таблицы делается непосредственно в migrator-sh-init.sh.
- Таблица шардируется по полю user_from, где хранится uuid пользователя. Предполагаю, что uuid уже достаточно случайный, с фиксированной длиной, поэтому пока не вижу смысла дополнительно хэшировать поле. Таким образом, сообщения от одного пользователя попадают в 1 шард. Дополнительно на поле user_to создан дефолтный B-tree индекс для ускорения работы метода `/dialog/get/<user_id>/list`. Т.к. искать придется по точному совпадению, такой индекс нам подходит.
- Также была мысль сделать foreign key на поле `social_net.users.user_id`, для обеспечения консистентности данных, но пока тоже отказался по 2 причинам. Во-первых, не решен вопрос честно ли удаляются пользователи - возможность восстановления может оказаться полезной для пользователя. В таком случае удаление скорее всего окажется не фактическим удаленим из таблицы, а какой-то пометкой, что потребует изменение DDL таблицы и методов. Во-вторых, удаление пользователя с большим количеством сообщений может спровоцировать повышенную нагрузку в случае каскадного удаления.

## Решардинг
- В качество инструмента шардинга выбра citus, в основном потому, что поддерживает решардирование без downtime.
Про решардирование нужно отметить 2 момента:

1. решардинг в изменением количество шардов выполняется с помощью команды:
```
social_net=# SELECT alter_distributed_table('social_net.messages', shard_count := 25);
NOTICE:  creating a new table for social_net.messages
NOTICE:  moving the data of social_net.messages
NOTICE:  dropping the old social_net.messages
NOTICE:  renaming the new table to social_net.messages
 alter_distributed_table 
-------------------------
 
(1 строка)

```

2. Если есть возможность добавить новый воркер в кластер, это можно сделать с помощью двух команд:

Команда, которая добавит ноду в кластер:
`SELECT * FROM citus_add_node(<new_node_name>, <new_node_port>);`

Команда, которая запустит ребалансировку шардов:
`SELECT citus_rebalance_start();`